<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manhattan Entry Points Map with Graphs</title>
    <style>
        #map-container {
            width: 1000px;
            height: 800px;
            border: 1px solid #ccc;
            margin: 20px auto;
            position: relative;
        }
        
        #nyc-map {
            width: 100%;
            height: 100%;
            background: #f5f5f5;
        }

        .map-title {
            position: absolute;
            top: 20px;
            left: 20px;
            font-family: Arial, sans-serif;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 4px;
        }

        .legend {
            position: absolute;
            top: 70px;  /* Positioned below the title */
            left: 20px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            z-index: 1000;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid white;
        }

        .legend-text {
            font-size: 12px;
            color: #333;
        }

        .neighborhood {
            fill: rgba(138, 43, 226, 0.1);
            stroke: #666;
            stroke-width: 0.5;
        }

        .street {
            fill: none;
            stroke: #ff4444;
            stroke-width: 1.5;
        }

        .entry-point {
            stroke: white;
            stroke-width: 2;
            cursor: pointer;
            transition: r 0.2s, stroke-width 0.2s;
        }

        .entry-point:hover {
            r: 8;
            stroke-width: 3;
        }

        /* Different colors for different types of entry points */
        .entry-point.bridge {
            fill: #4CAF50;  /* Green for bridges */
        }

        .entry-point.tunnel {
            fill: #2196F3;  /* Blue for tunnels */
        }

        .entry-point.highway {
            fill: #FFC107;  /* Yellow for highways */
        }

        .entry-point.street {
            fill: #9C27B0;  /* Purple for streets */
        }

        .entry-point-label {
            font-family: Arial, sans-serif;
            font-size: 8px;
            fill: #333;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 
                -0.5px -0.5px 0 white,
                0.5px -0.5px 0 white,
                -0.5px 0.5px 0 white,
                0.5px 0.5px 0 white;
        }

        .tooltip {
            position: absolute;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            pointer-events: none;
            display: none;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            max-width: 600px;
            width: 90%;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .popup-close {
            cursor: pointer;
            font-size: 24px;
            color: #666;
        }

        .popup-close:hover {
            color: #333;
        }

        .bar {
            fill: #4CAF50;
            transition: fill 0.3s;
        }

        .bar:hover {
            fill: #45a049;
        }

        .axis-label {
            font-family: Arial, sans-serif;
            font-size: 12px;
        }

        /* Add streamlit-specific styling */
        .stApp {
            margin: 0;
            padding: 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://streamlit.io/static/static/js/streamlit-component-lib.js"></script>
</head>
<body>
    <div id="map-container">
        <div class="map-title">CRZ Entrypoints</div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot" style="background: #4CAF50;"></div>
                <span class="legend-text">Entry Points</span>
            </div>
        </div>
        <svg id="nyc-map"></svg>
    </div>
    <div class="tooltip"></div>
    <div class="popup">
        <div class="popup-header">
            <h2 id="popup-title">Traffic Data</h2>
            <span class="popup-close">&times;</span>
        </div>
        <div id="graph-container"></div>
    </div>

    <script>
        // Sample traffic data for each entry point
        const trafficData = {
            "Brooklyn Bridge": [
                {hour: "6AM", volume: 3200},
                {hour: "9AM", volume: 5600},
                {hour: "12PM", volume: 4100},
                {hour: "3PM", volume: 4800},
                {hour: "6PM", volume: 6200},
                {hour: "9PM", volume: 3800}
            ],
            // Add similar data for other entry points...
        };

        // Function to create/update the graph
        function showGraph(entryPoint) {
            // Clear previous graph
            d3.select('#graph-container').html('');

            // Generate random data if not available
            const data = trafficData[entryPoint.name] || Array.from({length: 6}, (_, i) => ({
                hour: `${(i * 3 + 6) % 24}:00`,
                volume: Math.floor(Math.random() * 5000 + 2000)
            }));

            // Set up graph dimensions
            const margin = {top: 20, right: 20, bottom: 40, left: 60};
            const width = 500 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            // Create SVG
            const svg = d3.select('#graph-container')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Set up scales
            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .range([height, 0]);

            // Set domains
            x.domain(data.map(d => d.hour));
            y.domain([0, d3.max(data, d => d.volume)]);

            // Add X axis
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            // Add Y axis
            svg.append('g')
                .call(d3.axisLeft(y));

            // Add bars
            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d.hour))
                .attr('width', x.bandwidth())
                .attr('y', d => y(d.volume))
                .attr('height', d => height - y(d.volume));

            // Add labels
            svg.append('text')
                .attr('class', 'axis-label')
                .attr('text-anchor', 'middle')
                .attr('transform', `translate(${-40},${height/2})rotate(-90)`)
                .text('Traffic Volume');

            // Show popup
            document.querySelector('.popup').style.display = 'block';
        }

        // Update the entry points data to include types
        const entryPoints = [
            { name: "Brooklyn Bridge", coords: [-73.9968, 40.7061], type: "bridge" },
            { name: "West Side Highway at 60th St", coords: [-73.9908, 40.7714], type: "highway" },
            { name: "West 60th St", coords: [-73.9832, 40.7691], type: "street" },
            { name: "Queensboro Bridge", coords: [-73.9540, 40.7558], type: "bridge" },
            { name: "Queens Midtown Tunnel", coords: [-73.9421, 40.7467], type: "tunnel" },
            { name: "Lincoln Tunnel", coords: [-74.002838, 40.760106], type: "tunnel" },
            { name: "Holland Tunnel", coords: [-74.011121, 40.726138], type: "tunnel" },
            { name: "FDR Drive at 60th St", coords: [-73.9597, 40.7576], type: "highway" },
            { name: "East 60th St", coords: [-73.9684, 40.7616], type: "street" },
            { name: "Williamsburg Bridge", coords: [-73.9720, 40.7127], type: "bridge" },
            { name: "Manhattan Bridge", coords: [-73.9907, 40.7074], type: "bridge" },
            { name: "Hugh L. Carey Tunnel", coords: [-74.0141, 40.7046], type: "tunnel" }
        ];

        // Load GeoJSON data
        Promise.all([
            fetch('https://raw.githubusercontent.com/codeforgermany/click_that_hood/main/public/data/manhattan.geojson').then(resp => resp.json()),
            fetch('https://raw.githubusercontent.com/fillerwriter/nyc-streets/master/nyc-streets.geojson').then(resp => resp.json())
        ]).then(([manhattanData, streetData]) => {
            const svg = d3.select('#nyc-map');
            const width = 1000;
            const height = 800;
            const tooltip = d3.select('.tooltip');

            // Manhattan bounds (approximately)
            const manhattanBounds = {
                left: -74.02,    // westernmost longitude
                right: -73.93,   // easternmost longitude
                bottom: 40.70,   // southernmost latitude
                top: 40.77       // northernmost latitude
            };

            // Create projection specifically for Manhattan
            const projection = d3.geoMercator()
                .center([-73.98, 40.735]) // Center of Manhattan
                .scale(200000)           // Zoom level
                .translate([width / 2, height / 2]);

            // Create path generator
            const path = d3.geoPath()
                .projection(projection);

            // Draw Manhattan neighborhoods
            svg.selectAll('.neighborhood')
                .data(manhattanData.features)
                .enter()
                .append('path')
                .attr('d', path)
                .attr('class', 'neighborhood');

            // Draw streets
            svg.selectAll('.street')
                .data(streetData.features)
                .enter()
                .append('path')
                .attr('d', path)
                .attr('class', 'street');

            // Create a group for entry points and their labels
            const entryPointsGroup = svg.append('g')
                .attr('class', 'entry-points-group');

            // Add entry points
            entryPointsGroup.selectAll('.entry-point')
                .data(entryPoints)
                .enter()
                .append('circle')
                .attr('class', 'entry-point')
                .attr('cx', d => projection(d.coords)[0])
                .attr('cy', d => projection(d.coords)[1])
                .attr('r', 6)
                .style('fill', '#4CAF50')
                .style('stroke', 'white')
                .style('stroke-width', '2')
                .on('click', function(event, d) {
                    handleEntryPointClick(d);
                })
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('r', 8);
                    
                    tooltip
                        .style('display', 'block')
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY + 10) + 'px')
                        .html(`${d.name}`);
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('r', 6);
                    
                    tooltip.style('display', 'none');
                });

            // Modified label addition with better text handling
            entryPointsGroup.selectAll('.entry-point-label')
                .data(entryPoints)
                .enter()
                .append('text')
                .attr('class', 'entry-point-label')
                .attr('x', d => projection(d.coords)[0])
                .attr('y', d => projection(d.coords)[1] - 8) // Reduced distance from dot
                .text(d => {
                    // Simplified name processing
                    const name = d.name;
                    if (name.includes('Highway')) return 'W Side Hwy';
                    if (name.includes('Tunnel')) return name.replace('Tunnel', 'Tnl');
                    if (name.includes('Bridge')) return name.replace('Bridge', 'Br');
                    if (name.includes('Street')) return name.replace('Street', 'St');
                    if (name.includes('Drive')) return name.replace('Drive', 'Dr');
                    return name;
                });

            // Initialize svg-pan-zoom with custom initial view
            const panZoomInstance = svgPanZoom('#nyc-map', {
                zoomEnabled: true,
                controlIconsEnabled: true,
                fit: false,  // Disable automatic fitting
                center: false, // Disable automatic centering
                minZoom: 0.8,
                maxZoom: 15,
                zoomScaleSensitivity: 0.5,
                beforePan: function(oldPan, newPan) {
                    // Optional: Add pan limits to keep focus on Manhattan
                    const sizes = this.getSizes();
                    const leftLimit = -((sizes.viewBox.width * sizes.realZoom) - sizes.width);
                    const rightLimit = 0;
                    const topLimit = -((sizes.viewBox.height * sizes.realZoom) - sizes.height);
                    const bottomLimit = 0;

                    const customPan = {};
                    customPan.x = Math.max(Math.min(newPan.x, rightLimit), leftLimit);
                    customPan.y = Math.max(Math.min(newPan.y, bottomLimit), topLimit);

                    return customPan;
                }
            });

            // Set initial zoom and position
            panZoomInstance.zoom(1.0);  // Adjust this value to get the desired zoom level
            
            // Add close button functionality
            document.querySelector('.popup-close').addEventListener('click', function() {
                document.querySelector('.popup').style.display = 'none';
            });
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('map-container').innerHTML = 
                `<p style="color: red; padding: 20px;">Error loading map data. Please check console for details.</p>`;
        });

        // Modify the click handler to communicate with Streamlit
        function handleEntryPointClick(entryPoint) {
            // Send the selected entry point to Streamlit
            if (window.Streamlit) {
                window.Streamlit.setComponentValue({
                    entryPoint: entryPoint.name,
                    coords: entryPoint.coords
                });
            }
        }
    </script>
</body>
</html>